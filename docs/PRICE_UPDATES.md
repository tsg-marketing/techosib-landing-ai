# Автоматическое обновление цен

## Как это работает

Цены на паллетообмотчики автоматически загружаются из XML-фида при каждом открытии сайта.

### Процесс обновления

1. **При загрузке страницы**:
   - Хук `usePrices()` проверяет кэш в localStorage
   - Если кэш актуален (< 24 часов) → используются кэшированные цены
   - Если кэш устарел или отсутствует → делается запрос к API

2. **Запрос к API**:
   ```
   GET https://functions.poehali.dev/c5dcf94d-754c-4745-b50e-37b437be727a
   ```
   - Бэкенд-функция парсит XML-фид с t-sib.ru
   - Извлекает цены по offer_id (6323, 6366, 6373, 6324, 6368, 6367, 6369, 6370)
   - Возвращает JSON с форматированными ценами

3. **Обновление интерфейса**:
   - Цены сохраняются в state React
   - Все блоки автоматически перерисовываются с новыми ценами
   - Данные кэшируются в localStorage на 24 часа

### Где отображаются цены

✅ **Главный баннер** - "От {minPrice} руб"
✅ **Блок "Модели паллетообмотчиков"** - цена в каждой карточке
✅ **Блок "Сравнительная таблица"** - строка "Цена" для всех моделей
✅ **Результаты квиза** - цена рекомендованной модели

### Fallback механизм

Если API недоступен или произошла ошибка:
- Используются статические цены из массива `models[]`
- Пользователь видит цены, но они могут быть неактуальными
- В консоли браузера появится сообщение об ошибке

### Отладка

Откройте консоль браузера (F12) и проверьте логи:

```
Using cached prices: {...}  // Если используется кэш
Loaded prices from API: {...}  // Если загружено из API
```

### Принудительное обновление

Чтобы сбросить кэш и загрузить свежие цены:

```javascript
// В консоли браузера
localStorage.removeItem('prices_cache');
location.reload();
```

### Структура кэша

```json
{
  "data": {
    "prices": {
      "TS3000MR-H": "310 392",
      "TS3000SPS-H": "332 262",
      ...
    },
    "min_price": "310 392"
  },
  "timestamp": 1703001234567
}
```

### Технические детали

- **Кэш**: localStorage, ключ `prices_cache`
- **Срок действия**: 24 часа (86400000 мс)
- **Формат цен**: с пробелами между разрядами ("310 392")
- **Обновление**: автоматическое при загрузке страницы
- **Fallback**: статические цены из кода

## Изменение offer_id

Если в XML-фиде изменятся offer_id, обновите маппинг в:
```
backend/update-prices/index.py
```

И выполните деплой:
```bash
sync_backend
```

## Мониторинг

Проверить работу API:
```bash
curl https://functions.poehali.dev/c5dcf94d-754c-4745-b50e-37b437be727a
```

Должен вернуть JSON с 8 моделями и их ценами.
